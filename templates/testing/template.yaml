type: pipeline-template
version: 1
name: Testing 2 multibranches
description: Testing 2 multibranches
templateType: MULTIBRANCH
parameters:
  - name: organisation
    displayName: GitHub Organisation
    type: string
  - name: repoName
    displayName: Git Repository
    type: string
  - name: githubAppKey
    displayName: GitHub App Key
    type: CREDENTIALS
  - name: sourceToBuild
    displayName: Source to build
    type: string
    defaultValue: main
  #- name: pipelineToRun
  #  displayName: Pipeline To Run - Accepted Options - ci-flow, hdpv2-self-release
  #  type: string
  #  defaultValue: ci-flow

#see https://docs.cloudbees.com/docs/admin-resources/latest/pipeline-templates-user-guide/managing-multibranch-pipeline-options#_example
# for options of multibranch, see https://www.jenkins.io/doc/pipeline/steps/params/multibranch/
multibranch:
  markerFile: ci-config.yaml
  branchSource:
    github:
      apiUri: https://www.test.com
      repoOwner: ${organisation}
      repository: ${repoName}
      credentialsId: ${githubAppKey}
      traits:
          - gitHubBranchDiscovery:
              strategyId: 3
          - gitHubPullRequestDiscovery:
              strategyId: 2
          - gitHubForkDiscovery:
              trust:
                gitHubTrustEveryone: {
                  }
              strategyId: 2
          - headRegexFilter:
              regex: ${sourceToBuild}
          - gitHubTagDiscovery: {
            }
          - gitHubIgnoreDraftPullRequestFilter: {
            }
    #buildStrategies:
    #  - skipInitialBuildOnFirstIndexingResetRevision: {
    #    }
    strategy:
      allBranchesSame:
        props:
        - suppressAutomaticTriggering:
            triggeredBranchesRegex: ${sourceToBuild}
            strategy: INDEXING
multibranch:
  markerFile: ci-config.yaml
  branchSource:
    bitbucket:
      serverUrl: ${bitbucketServerUrl}
      repoOwner: ${owner}
      repository: ${repoName}
      credentialsId: ${bitBucketToken}
      traits:
          - bitbucketBranchDiscovery:
              strategyId: 3
          - bitbucketPullRequestDiscovery:
              strategyId: 2
          - bitbucketForkDiscovery:
              trust:
                bitbucketTrustEveryone: {
                  }
              strategyId: 2
          - headRegexFilter:
              regex: ${sourceToBuild}
          - bitbucketTagDiscovery: {
            }
    #buildStrategies:
    #  - skipInitialBuildOnFirstIndexingResetRevision: {
    #    }
    strategy:
      allBranchesSame:
        props:
        - suppressAutomaticTriggering:
            triggeredBranchesRegex: ${sourceToBuild}
            strategy: INDEXING
